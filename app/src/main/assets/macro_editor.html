<!DOCTYPE html>
<html>
<head>
    <title>Macro Editor</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f5f5f5; }
        h1 { text-align: center; }
        #macros-container { display: flex; flex-direction: column; gap: 15px; }
        .macro { padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .macro label { display: block; margin-bottom: 5px; font-weight: bold; }
        .macro input[type='text'] { width: calc(100% - 22px); padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .macro .color-picker { width: 100%; height: 40px; padding: 0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
        .controls { margin-top: 20px; text-align: center; }
        button { padding: 12px 20px; border-radius: 5px; border: none; cursor: pointer; font-size: 16px; }
        .save-btn { background-color: #4CAF50; color: white; }
        .add-btn { background-color: #008CBA; color: white; }
        .delete-btn { background-color: #f44336; color: white; float: right; }
    </style>
</head>
<body>
    <h1>Macro Editor</h1>
    <div id="macros-container"></div>
    <div class="controls">
        <button class="add-btn" onclick="addMacro()">Add New Macro</button>
        <button class="save-btn" onclick="saveMacros()">Save and Close</button>
    </div>

    <script>
        const ws = new WebSocket(`ws://${window.location.host}/webrtc`);
        const macrosContainer = document.getElementById('macros-container');
        let currentMacros = [];

        ws.onopen = () => {
            console.log("CLIENT: WebSocket Connected");
            ws.send(JSON.stringify({ type: 'getMacros' }));
        };

        ws.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                if (message.type === 'macros') {
                    currentMacros = JSON.parse(message.data);
                    renderMacros();
                } else if (message.type === 'macrosSaved') {
                    alert('Macros saved successfully!');
                    window.close();
                }
            } catch (e) {
                console.error("Error parsing message", e);
            }
        };

        function renderMacros() {
            macrosContainer.innerHTML = '';
            currentMacros.forEach((macro, index) => {
                const macroDiv = document.createElement('div');
                macroDiv.className = 'macro';
                macroDiv.innerHTML = `
                    <button class="delete-btn" onclick="deleteMacro(${index})">Delete</button>
                    <label for="name-${index}">Name:</label>
                    <input type="text" id="name-${index}" value="${macro.name}">
                    <label for="command-${index}">Command:</label>
                    <input type="text" id="command-${index}" value="${macro.command}">
                    <label for="color-${index}">Color:</label>
                    <input type="color" id="color-${index}" class="color-picker" value="${macro.colorHex || '#ffffff'}">
                `;
                macrosContainer.appendChild(macroDiv);
            });
        }

        function addMacro() {
            currentMacros.push({ name: 'New Macro', command: '', colorHex: '#ffffff' });
            renderMacros();
        }

        function deleteMacro(index) {
            if (confirm('Are you sure you want to delete this macro?')) {
                currentMacros.splice(index, 1);
                renderMacros();
            }
        }

        function saveMacros() {
            const macroDivs = macrosContainer.children;
            const updatedMacros = [];
            for (let i = 0; i < macroDivs.length; i++) {
                const name = macroDivs[i].querySelector(`[id^='name-']`).value;
                const command = macroDivs[i].querySelector(`[id^='command-']`).value;
                const colorHex = macroDivs[i].querySelector(`[id^='color-']`).value;
                updatedMacros.push({ name, command, colorHex });
            }
            currentMacros = updatedMacros;
            ws.send(JSON.stringify({ type: 'saveMacros', data: JSON.stringify(currentMacros) }));
        }
    </script>
</body>
</html>